<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>Python Web Performance 101: Uncovering the root causes</title>

    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>

<py-config>
packages = ["pyflame"]
terminal = false

[[fetch]]
from = "./load"
files = ["parsing-document-in-cpu-intensive-application.py"]

[[fetch]]
from = "./"
files = ["calls.py"]

</py-config>

<style type="text/css">
.py-terminal {
    min-height: 10em;
    background-color: wheat;
    color: black;
    padding: 0.5rem;
    overflow: auto;
}

.pres-scene {
    display: none;
}

.pres-scene--choosen {
    display: block;
}

.topic {
    text-align: center;
    vertical-align: center;
}
</style>

<script>
    const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
    });

    // console.log('Params', params)
    // const loadStageValue = params.stage
    // let loadStage = null;
    // if (loadStageValue != undefined) {
    //     loadStage = parseInt(loadStageValue);
    //     console.log('Load stage', currentStage, loadStageValue)
    // }

    function clearStagePyTerminal(stageElem) {
        const pyTerminalElems = stageElem.getElementsByTagName("py-terminal")
        if (!pyTerminalElems.length) {
            return;
        }
        console.log('pyTerminalElems', pyTerminalElems)
        const preTerminalElems = pyTerminalElems[0].getElementsByTagName("pre")
        if (!preTerminalElems.length) {
            return;
        }
        console.log('preTerminalElems', preTerminalElems)
        preTerminalElems[0].innerHTML = ''
    }

    function load_content(file, id) {
        console.log('Loading', file, id)
        const url = file
        fetch(url)
        .then( r => r.text() )
        .then( t => {
            document.getElementById(id).innerHTML = t
            hljs.highlightAll();
        })
    }

    function showScene(modifier) {
        const currSceneElems = document.getElementsByClassName("pres-scene--choosen")
        console.log('Curr Scene', currSceneElems)
        const currSceneElem = currSceneElems[0]
        let showSceneElem = null
        if (modifier == 1) {
            showSceneElem = currSceneElem.nextSibling.nextSibling
        } else if (modifier == -1) {
            showSceneElem = currSceneElem.previousSibling.previousSibling
        } else {
            throw new Error('Only supported +1/-1 modifier!')
        }

        console.log('showSceneElem', showSceneElem)
        if (!showSceneElem) {
            return
        }

        if (!showSceneElem.classList.contains("pres-scene")) {
            return
        }

        if (currSceneElem && currSceneElem != showSceneElem) {
            clearStagePyTerminal(currSceneElem)
            currSceneElem.classList.remove("pres-scene--choosen")
        }
        showSceneElem.classList.add("pres-scene--choosen")

        // const el = showSceneElem.getElementsByClassName('cm-content')
        // console.log('FF', el);
        // if (el.length) {
        //     el[0].dispatchEvent(new KeyboardEvent("keyup", {
        //         key: "enter",
        //         // code: "KeyEnter", // put everything you need in this object.
        //         keyCode: 13,
        //         shiftKey: false, // you don't need to include values
        //         ctrlKey: true,  // if you aren't going to use them.
        //         metaKey: false   // these are here for example's sake.
        //     }));
        // }
    }

    window.addEventListener('load', (event) => {
        console.log('Show stage', 'xxx')

        load_content('load/memory_profiler.py', 'memory_profiler_py')
        load_content('out/memory_profiler.txt', 'memory_profiler_bash_output')

        load_content('load/py-spy.py', 'py_spy_py')
    })

    document.addEventListener('keyup', (event) => {
        console.log('keyup', event)
        if (event.code == 'KeyA') {
            showScene(-1)
        } else if (event.code == 'KeyD' || event.code == 'Space') {
            showScene(+1)
        }
    });
</script>

<div id="contents" style="display: none;">
Python web performance 101: uncovering the root causes

Web engineers meet issues with performance with fast-growing or even maintaining existing products. Itâ€™s always unexpected and we have limited time for decisions. With our hero, we meet real-faced RAM, CPU and IO problems and learn troubleshooting approaches to monolithic and distributed systems.

We try different existing tools from Python and the cloud ecosystem including, but not limited to: cProfile, yappi, memory-profiler and tracing.

This talk will be more focused on backend parts and designed for intermediate-level web engineers, but all skill levels are welcome.

- time and timeit
- cProfile
- snakeviz things
- yappi
-
</div>

<div class="pres-scene">
</div>

<div class="pres-scene">
    <py-repl>
        print('Python Web Performance 101: Uncovering the root causes')
        print('By Alex Ptakhin')
        print('Senior Software Engineer at Prestatech GmbH')
        print('me@aptakhin.name')
    </py-repl>
</div>

<div class="pres-scene">
    <py-repl>
        print('Who at least once used timeit, time.perfcounter(), CPU or memory usage profilers?')
    </py-repl>
</div>

<div class="pres-scene">
    <py-repl>
        print('David')
    </py-repl>
</div>

<div class="pres-scene">
    <py-repl>
        print('Coffee')
    </py-repl>
</div>

<div class="pres-scene">
    <py-repl>
        print('Performance issues')
    </py-repl>
</div>

<div class="pres-scene">
    <py-repl>
        print('Scale-in: more CPU, more RAM')
    </py-repl>
</div>

<div class="pres-scene">
    <py-repl>
        print('Now David has time to debug')
    </py-repl>
</div>

<div class="pres-scene">
    <h2 class="topic">CPU</h2>
</div>

<div class="pres-scene">
    <py-repl>
        import time
        from calls import cpu_intensive_call

        start = time.perf_counter()

        cpu_intensive_call(num_iterations=5000000)

        end = time.perf_counter()
        print('Elapsed seconds: {:.1f}'.format(end - start))
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <py-repl>
        print('time.perf_counter')
        print('Pros: out of box')
    </py-repl>
</div>

<div class="pres-scene">
    <py-repl>
        print('time.perf_counter')
        print('Pros: out of box')
        print('Cons: need to edit code, no internal performance details')
    </py-repl>
</div>

<div class="pres-scene pres-scene--choosen">
    <py-repl>
        import cProfile
        import re

        from calls import cpu_intensive_call

        cProfile.run('cpu_intensive_call(num_iterations=5000000)')
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <pre><code class="language-python" id="py_spy_py"></code></pre>

    <pre><code class="language-bash">$ py-spy record -o out/py-spy.svg -- python load/py-spy.py
    </code></pre>

    <!-- py-spy record -o profile.svg -- python load/py-spy.py -->

    <img src="out/py-spy.svg">
</div>


<div class="pres-scene">
    <h2 class="topic">RAM</h2>
</div>

<div class="pres-scene">
    <pre><code class="language-python" id="memory_profiler_py"></code></pre>

    <pre><code class="language-bash">$ python -m memory_profiler load/memory_profiler.py
    </code></pre>

    <!-- python -m memory_profiler load/memory_profiler.py > out/memory_profiler.txt -->

    <pre><code class="language-bash" id="memory_profiler_bash_output"></code></pre>
</div>

<div class="pres-scene">
    <h2 class="topic">IO</h2>
</div>

<div class="pres-scene">
    <h2 class="topic">Tracing</h2>
</div>

<div class="pres-scene">
    <h2 class="topic">Conclusion</h2>
</div>

<div class="pres-scene">
    <h2 class="topic">Thank you!</h2>
    <h3 class="topic">PyScript, highlight.js, Prestatech GmbH</h3>
</div>

</body>
</html>
