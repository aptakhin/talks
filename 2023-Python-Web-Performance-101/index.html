<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>Python Web Performance 101: Uncovering the root causes</title>

    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>

<py-config>
packages = ["pyflame", "opentelemetry-distro"]
terminal = false

[[fetch]]
from = "./load"
files = ["parsing-document-in-cpu-intensive-application.py"]

[[fetch]]
from = "./load"
files = ["py_ff.py"]

[[fetch]]
from = "./"
files = ["objects.py"]

[[fetch]]
from = "./"
files = ["calls.py"]

[[fetch]]
from = "./"
files = ["helpers.py"]

</py-config>

<style type="text/css">
.py-terminal {
    min-height: 10em;
    background-color: wheat;
    color: black;
    padding: 0.5rem;
    overflow: auto;
}

.pres-scene {
    display: none;
}

.pres-speech {
    display: none;
}

.pres-scene--choosen {
    display: block;
}

.topic {
    text-align: center;
    vertical-align: center;
}
</style>

<script>
    const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
    });

    // console.log('Params', params)
    // const loadStageValue = params.stage
    // let loadStage = null;
    // if (loadStageValue != undefined) {
    //     loadStage = parseInt(loadStageValue);
    //     console.log('Load stage', currentStage, loadStageValue)
    // }

    function clearStagePyTerminal(stageElem) {
        const pyTerminalElems = stageElem.getElementsByTagName("py-terminal")
        if (!pyTerminalElems.length) {
            return;
        }
        console.log('pyTerminalElems', pyTerminalElems)
        const preTerminalElems = pyTerminalElems[0].getElementsByTagName("pre")
        if (!preTerminalElems.length) {
            return;
        }
        console.log('preTerminalElems', preTerminalElems)
        preTerminalElems[0].innerHTML = ''
    }

    function load_content(file, id) {
        console.log('Loading', file, id)
        const url = file
        fetch(url)
        .then( r => r.text() )
        .then( t => {
            document.getElementById(id).innerHTML = t
            hljs.highlightAll();
        })
    }

    function showScene(modifier) {
        const currSceneElems = document.getElementsByClassName("pres-scene--choosen")
        console.log('Curr Scene', currSceneElems)
        const currSceneElem = currSceneElems[0]
        let showSceneElem = null
        if (modifier == 1) {
            showSceneElem = currSceneElem.nextSibling.nextSibling
        } else if (modifier == -1) {
            showSceneElem = currSceneElem.previousSibling.previousSibling
        } else {
            throw new Error('Only supported +1/-1 modifier!')
        }

        console.log('showSceneElem', showSceneElem)
        if (!showSceneElem) {
            return
        }

        if (!showSceneElem.classList.contains("pres-scene")) {
            return
        }

        if (currSceneElem && currSceneElem != showSceneElem) {
            clearStagePyTerminal(currSceneElem)
            currSceneElem.classList.remove("pres-scene--choosen")
        }
        showSceneElem.classList.add("pres-scene--choosen")

        // const el = showSceneElem.getElementsByClassName('cm-content')
        // console.log('FF', el);
        // if (el.length) {
        //     el[0].dispatchEvent(new KeyboardEvent("keyup", {
        //         key: "enter",
        //         // code: "KeyEnter", // put everything you need in this object.
        //         keyCode: 13,
        //         shiftKey: false, // you don't need to include values
        //         ctrlKey: true,  // if you aren't going to use them.
        //         metaKey: false   // these are here for example's sake.
        //     }));
        // }
    }

    window.addEventListener('load', (event) => {
        console.log('Show stage', 'xxx')

        load_content('load/memory_profiler.py', 'memory_profiler_py')
        load_content('out/memory_profiler.txt', 'memory_profiler_bash_output')

        load_content('load/asyncio_yappi.py', 'asyncio_yappi_py')
        load_content('out/asyncio_yappi.txt', 'asyncio_yappi_py_output')

        load_content('load/py-spy.py', 'py_spy_py')
    })

    document.addEventListener('keyup', (event) => {
        console.log('keyup', event)
        if (event.code == 'KeyA') {
            showScene(-1)
        } else if (event.code == 'KeyD'/* || event.code == 'Space'*/) {
            showScene(+1)
        }
    });
</script>

<div id="contents" style="display: none;">
Python web performance 101: uncovering the root causes

Web engineers meet issues with performance with fast-growing or even maintaining existing products. Itâ€™s always unexpected and we have limited time for decisions. With our hero, we meet real-faced RAM, CPU and IO problems and learn troubleshooting approaches to monolithic and distributed systems.

We try different existing tools from Python and the cloud ecosystem including, but not limited to: cProfile, yappi, memory-profiler and tracing.

This talk will be more focused on backend parts and designed for intermediate-level web engineers, but all skill levels are welcome.

---
22 minutes.

Structure
Introduction (2 min.)
CPU (5 min)
- time and timeit
- cProfile
- snakeviz things
- yappi
RAM (5 min)
- memory_profiler
IO (3 min)
- heavy loaded, processing big files
Tracing (4 min)
Conclusion (3 min)

</div>

<div class="pres-scene">
    <h2 class="topic">First almost white screen</h2>
</div>

<div class="pres-scene">
    <h2 class="topic">Second almost white screen</h2>
</div>

<div class="pres-scene">
    <py-repl>
        print('Python Web Performance 101: Uncovering the root causes')
        print('By Alex Ptakhin')
        print('Senior Software Engineer at Prestatech GmbH, Berlin')
        print('me@aptakhin.name https://twitter.com/aptakhin https://linkedin.com/in/aptakhin')
    </py-repl>

    <div class="pres-speech">
        Who at least once used timeit, time.perfcounter(), CPU or memory usage profilers?
    </div>
</div>

<div class="pres-scene">
    <py-repl>
        print('Made up story. No one was hurt!')
    </py-repl>

    <div class="pres-speech">
        David
    </div>
</div>

<div class="pres-scene">
    <py-repl>
        print('Performance issues')
    </py-repl>

    <!-- TODO: htop CPU image: python load/parsing-document-in-cpu-intensive-application.py -->
</div>

<div class="pres-scene">
    <py-repl>
        print('Scale-in: more CPU, more RAM')
    </py-repl>

    <div class="pres-speech">
        Now David has time to debug
    </div>
</div>

<div class="pres-scene">
    <h2 class="topic">CPU</h2>
</div>

<div class="pres-scene">
    <!-- TODO: more interesting cpu_intensive_call with details -->

    <py-repl>
        import time
        from calls import cpu_intensive_call

        start = time.perf_counter()

        cpu_intensive_call(num_iterations=5000000)

        end = time.perf_counter()
        print('Elapsed seconds: {:.1f}'.format(end - start))
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <h3 class="topic">time.perf_counter</h3>

    <py-repl>
        print('Out of box')
    </py-repl>
</div>

<div class="pres-scene">
    <h3 class="topic">time.perf_counter</h3>

    <py-repl>
        print('Out of box')
        print('Need to edit code, no internal details')
    </py-repl>
</div>

<div class="pres-scene">
    <h3 class="topic">cProfile</h3>

    <py-repl>
        import cProfile
        import re

        from calls import cpu_intensive_call

        cProfile.run('cpu_intensive_call(num_iterations=5000000)')
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <h3 class="topic">cProfile</h3>

    <pre><code class="language-bash">$ python -m cProfile \
    -o out/cpu-intensive-program.prof \
    load/cpu-intensive-program.py
$ snakeviz out/cpu-intensive-program.prof
    </code></pre>

    <!-- TODO: image for more interesting cpu-intensive-program -->
</div>

<div class="pres-scene">
    <h3 class="topic">cProfile</h3>

    <py-repl>
        print('Out of box')
        print('Internal details timings')
    </py-repl>
</div>

<div class="pres-scene">
    <h3 class="topic">cProfile</h3>

    <py-repl>
        print('Out of box')
        print('Internal details timings')
        print('Have visualize extensions')
    </py-repl>
</div>

<div class="pres-scene">
    <h3 class="topic">cProfile</h3>

    <py-repl>
        print('Perfect! Is this all?')
    </py-repl>
</div>

<div class="pres-scene">
    <h3 class="topic">cProfile</h3>

    <py-repl>
        print('Perfect! Is this all?')
        print('Measuring something can change a behaviour of the system')
    </py-repl>
</div>

<div class="pres-scene">
    <pre><code class="language-python" id="py_spy_py"></code></pre>

    <pre><code class="language-bash">$ py-spy record -o out/py-spy.svg -- python load/py-spy.py
    </code></pre>

    <!-- py-spy record -o profile.svg -- python load/py-spy.py -->

    <img src="out/py-spy.svg">

    <div class="pres-speech">
        Sampling profilers - gets traces after
    </div>
</div>

<div class="pres-scene">
    <h3 class="topic">py-spy</h3>

    <py-repl>
        print('Sampling profiler')
    </py-repl>
</div>

<div class="pres-scene">
    <h3 class="topic">py-spy</h3>

    <py-repl>
        print('Sampling profiler')
        print('Requires developer environment')
    </py-repl>
</div>

<div class="pres-scene pres-scene--choosen">
    <h3 class="topic">Bonus: yappi for asyncio</h3>

    <pre><code class="language-python" id="asyncio_yappi_py"></code></pre>

    <pre><code class="language-bash">$ python load/asyncio_yappi.py > out/asyncio_yappi.txt
$ snakeviz out/asyncio_yappi.prof
    </code></pre>

    <pre><code class="language-bash" id="asyncio_yappi_py_output"></code></pre>

    <div class="pres-speech">
        Also very interesting profiler. Supports asynchronous execution
    </div>
</div>

<div class="pres-scene">
    <h3 class="topic">Bonus: yappi for asyncio</h3>

    <py-repl>
        print('Supports asynchronous execution')
        print('Different clock modes')
    </py-repl>
</div>

<div class="pres-scene">
    <!-- TODO: htop RAM image: python load/parsing-document-in-ram-intensive-application.py -->
    <h2 class="topic">After a few days</h2>

    <div class="pres-speech">
        After a few days failing processes and 500.
    </div>
</div>

<div class="pres-scene">
    <h2 class="topic">RAM</h2>

    <!--
        https://github.com/pyutils/line_profiler
    -->
</div>

<div class="pres-scene">
    <h3 class="topic">sys.getsizeof</h3>

    <py-repl>
        import sys

        print(f'Empty dict size: {sys.getsizeof({})}')
        print(f'Empty list size: {sys.getsizeof([])}')
        print(f'Empty set size: {sys.getsizeof(set())}')

        from objects import MemoryConsumer
        from helpers import total_size

        print(f'Custom class: {sys.getsizeof(MemoryConsumer())} {total_size(MemoryConsumer(), verbose=True)}')
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <h3 class="topic">tracemalloc</h3>

    <py-repl>
        import tracemalloc
        tracemalloc.start()
        from py_ff import my_func
        my_func()

        snapshot1 = tracemalloc.take_snapshot()

        my_func()

        snapshot2 = tracemalloc.take_snapshot()

        top_stats = snapshot2.compare_to(snapshot1, 'lineno')

        print("[ Top 10 differences ]")
        for stat in top_stats[:10]:
            print(stat)
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <pre><code class="language-python" id="memory_profiler_py"></code></pre>

    <pre><code class="language-bash">$ poetry add memory_profiler
$ python -m memory_profiler load/memory_profiler.py
    </code></pre>

    <pre><code class="language-bash" id="memory_profiler_bash_output"></code></pre>
</div>

<div class="pres-scene">
    <pre><code class="language-python" id="memory_profiler_py"></code></pre>

    <!--
        1. --attach PID.

        2. --backend {psutil,psutil_pss,psutil_uss,posix,tracemalloc}
                    Current supported backends: 'psutil', 'psutil_pss', 'psutil_uss', 'posix', 'tracemalloc'. Defaults to 'psutil'.

        3. include-children and multiprocess

        4. python -m memory_profiler --pdb-mmem=100 my_script.py

        5. >>> from memory_profiler import memory_usage
>>> mem_usage = memory_usage(-1, interval=.2, timeout=1)
>>> print(mem_usage)
    [7.296875, 7.296875, 7.296875, 7.296875, 7.296875] -->

    <pre><code class="language-bash">$ poetry add matplotlib
$ mprof run -o out/mprofile.dat load/memory_profiler.py
$ mprof plot -o out/mprofile.png out/mprofile.dat</code></pre>

    <pre><code class="language-bash" id="memory_profiler_bash_overview_output"></code></pre>
</div>

<div class="pres-scene">
    <py-repl>
        print('memory-profiler')
        print('Code changes for the detailed overview')
        print('Uses deprecated matplotlib.pylab')
        print('No longer maintained')
    </py-repl>

    <!-- memray -->
</div>

<div class="pres-scene">
    <h2 class="topic">IO</h2>

    <!-- TODO: Image IO -->
</div>

<div class="pres-scene">
    <h2 class="topic">General advices</h2>
    <ul>
        <li>Scale in</li>
        <li>Scale out</li>
        <li>Network</li>
    </ul>
</div>

<div class="pres-scene">
    <h2 class="topic">Tracing</h2>
</div>

<div class="pres-scene">
    <h3 class="topic">opentelemetry</h3>

    <py-repl>
        from calls import cpu_intensive_call
        from opentelemetry import trace

        tracer = trace.get_tracer(__name__)

        if __name__ == '__main__':
            with tracer.start_as_current_span("cpu_intensive_application") as parent:
                with tracer.start_as_current_span("cpu_intensive_call") as child:
                cpu_intensive_call(num_iterations=5000000)
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <h3 class="topic">opentelemetry</h3>

    <py-repl>
        from opentelemetry import trace, metrics
        from opentelemetry.sdk.trace import TracerProvider
        from opentelemetry.sdk.trace.export import SimpleSpanProcessor, ConsoleSpanExporter
        from opentelemetry.sdk.resources import SERVICE_NAME, Resource
        from opentelemetry.sdk.metrics import MeterProvider
        from opentelemetry.sdk.metrics.export import InMemoryMetricReader, ConsoleMetricExporter

        resource = Resource(attributes={
            SERVICE_NAME: "my-service"
        })

        reader = InMemoryMetricReader()
        provider = MeterProvider(resource=resource, metric_readers=[reader])
        if not metrics.get_meter_provider():
            metrics.set_meter_provider(provider)

        provider = TracerProvider(resource=resource)
        processor = SimpleSpanProcessor(ConsoleSpanExporter())
        provider.add_span_processor(processor)
        trace.set_tracer_provider(provider)

        from calls import cpu_intensive_call

        for x in range(3):
            with tracer.start_as_current_span("cpu_intensive_application") as parent:
                with tracer.start_as_current_span("cpu_intensive_call") as child:
                    cpu_intensive_call(num_iterations=5000000)
    </py-repl>

    <py-terminal></py-terminal>
</div>

<div class="pres-scene">
    <h2 class="topic">3 things to remember</h2>
    <ul>
        <li>Worth to have a chance win some time with resources</li>
    </ul>
</div>

<div class="pres-scene">
    <h2 class="topic">3 things to remember</h2>
    <ul>
        <li>Worth to have a chance win some time with resources</li>
        <li>Monitor application errors</li>
    </ul>
</div>

<div class="pres-scene">
    <h2 class="topic">3 things to remember</h2>
    <ul>
        <li>Worth to have a chance win some time with resources</li>
        <li>Monitor application errors</li>
        <li>Measuring something can change a behaviour of the system</li>
    </ul>
</div>

<div class="pres-scene">
    <h2 class="topic">Thank you!</h2>
    <h3 class="topic">PyScript, highlight.js, Prestatech GmbH</h3>
</div>

<div class="pres-scene">
    <h2 class="topic">References</h2>
    <ul>
        <li>https://github.com/sumerc/yappi/blob/master/doc/clock_types.md
            <ul>
                <li><a href="https://en.wikipedia.org/wiki/CPU_time" target="_blank">CPU Time</a></li>
                <li><a href="https://en.wikipedia.org/wiki/Elapsed_real_time" target="_blank">WALL Time</a></li>
            </ul>
        </li>
        <li>https://docs.python.org/3/library/tracemalloc.html</li>
        <li>https://bloomberg.github.io/memray/</li>
    </ul>
</div>

</body>
</html>
